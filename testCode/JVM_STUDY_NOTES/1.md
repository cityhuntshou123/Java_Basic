## JVM优化相关问题

1. 线上用 Dubbo 开发的一个系统突然卡死了，JVM Full GC太频繁，怎么处理？
2. 生产环境部署的一个系统隔几天就莫名的进程崩溃，看了眼异常信息，说是OOM内存溢出，如何解决？

> 我们平时写的Java代码，到底是怎么运行起来的？

当我们写好这些 ".java"后缀的代码文件之后，接下来要部署到线上的机器上运行，你会怎么做？

**一般来说，都是把代码打成".jar"后缀的jar包，或者是".war"后缀的war包。**

然后呢，就是把打包好的jar包或者war包放到线上机器上部署。

部署有很多途径，最基本的一种方式，就是通过Tomcat这类容器来部署代码，也可以自己手动通过 “java”  命令来运行一个jar包中的代码。



![image-20221111211231717](images\image-20221111211231717.png)

但是实际上这里有一个非常关键的步骤 -- **编译**。

也就是说，“.java” 代码在打包过程中，一般会把代码编译为 “.class”后缀的字节码文件，比如 User.class Hello.class Customer.class。

然后这个 ".class" 后缀的 ==字节码文件== ，才是可以被运行起来的。



![image-20221111211558870](images\image-20221111211558870.png)

--------

> **对于编译好的这些 ".class" 字节码，是怎么让他们运行起来的？**

使用 “Java -jar” 运行代码的时候，实际上此时就会启动一个 JVM 进程。

这个 JVM 进程就会负责运行 ".class" 字节码文件，也就相当于负责运行我们写好的系统。

**所以平时我们写好的某个系统在一台机器上部署的时候，一旦启动了这个系统，其实就是启动了一个JVM，由它来负责运行这台机器上运行的系统。**

![image-20221111212153652](images\image-20221111212153652.png)

------

JVM 要运行这些 ".class" 字节码文件中的代码，得首先把这些 ".class" 文件中包含的 ==各种类== 加载进来。

此时会采用 **类加载器**把编译好的 “.class” 字节码文件加载到JVM中，然后供后续代码运行使用。

![image-20221111212457345](images\image-20221111212457345.png)

-------

最后一步，JVM 基于自己的 **字节码执行引擎** ，来加载到内存里。

![image-20221111212628674](images\image-20221111212628674.png)

> **JVM 在什么情况下会加载一个类？**

当代码中用到这个类的时候。

具体的，首先代码中包含的 “main()” 方法的主类一定会在JVM进程启动之后被加载到内存，开始执行 “main()” 方法中的代码，接着使用到了别的类，就会从对应的 “.class” 字节码文件加载对应的类到内存中。

> **类加载过程中，主要包括 验证 准备 初始化 三个阶段**

（1） 验证阶段

根据 Java 虚拟机规范，校验加载进来的 ".class" 文件中的内容，是否符合指定的规范。

（2） **准备阶段**

给 类分配一定的内存空间，然后给里面的 ==类变量 (static 修改的变量)== 分配内存空间，来一个默认的初始值。

（3） 解析阶段

把符号引用替换为直接引用。 

（4）初始化阶段

正式执行类的初始化。

~~~java
public class ReplicaManager {
    public static int flushInterval = Configuraion.getInt("replica.flush.interval");
}
~~~

在这个阶段，就会执行类的初始化代码，比如上面的 Configuraion.getInt("replica.flush.interval") 代码就会在这里执行，完成一个配置项的读取，赋值给这个类变量 -- flushInterval.

static 静态代码块也是在这个阶段执行。

> 什么时候会初始化一个类？

1. 使用new关键字的时候，就会实例化类对象，此时会触发类的加载到初始化的全过程，把这个类准备好，再实例化一个对象出来；

2. 包含 "main()" 方法的主类，必须是立马初始化的。

   特别的，如果初始化一个类的时候，发现其父类还没初始化，就必须先初始化父类。

   

![image-20221111214708636](images\image-20221111214708636.png)

----------

